@model TestMe.Models.Test
@{

}
<div class="container-fluid">
    <div id="startTestElem" class="row">
        @Html.AntiForgeryToken()
        <h1 class="text-center col-md-12">@Model.TestName</h1>
        <h2 class="col-md-12">Author: @Model.AppUser.UserName</h2>
        <h3 class="col-md-12">Creation date: @Model.CreationDate</h3>
        <h4 class="col-md-12">Question amount: @Model.TestQuestions.Count</h4>
        <input type="hidden" value="@Model.TestCode" id="testCode" />
        <button type="button" class="btn btn-primary btn-lg center-block col-md-12" id="startButton">Start test</button>
    </div>
    <div id="questionBlock" class="row" display="none">
        @Html.AntiForgeryToken()
        <fieldset id="testQuestionFieldSet" class="col-md-12">
            <legend id="questionText">
                <div class="row">

                </div>
            </legend>
        </fieldset>
        <div id="questions" class="row">

        </div>
    </div>
<div/>
@section Scripts{
    <script type="text/javascript">
        function startTest() {
            var token = $('input[name="__RequestVerificationToken"]', $('#startTestElem')).val();
            var myData = { code: $("#testCode").val() };
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });

            $.ajax({
                url: "/TestEngine/StartTest",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data != "error")
                    {
                        ConfigureForTheFirstQuestion(data);
                        getQuestionsId();
                    }
                },
                error: function () {
                    $("#questionForm").empty();
                }
            });
        }
        function CheckAnswer(questionId, checkedArray) {
            var token = $('input[name="__RequestVerificationToken"]', $('#questionBlock')).val();
            if (checkedArray === undefined) {
                checkedArray = new Array();
                $('input[name="answer"]:checked').each(function () {
                    checkedArray.push(this.value);
                });
            }

            var myData = { checkedIds: checkedArray };
            if (typeof questionId !== 'number') {
                questionId = $("#testQuestionFieldSet").data('id');
            }
            var testCode = $("#testQuestionFieldSet").data("testCode");
            myData = $.extend(myData, { 'questionId': questionId });
            myData = $.extend(myData, { 'testCode': testCode });
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });
            $.ajax({
                url: "/TestEngine/CheckAnswer",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data !== "error") {
                        showCorrectAnswer(data, checkedArray);
                    }
                    else {
                        $("#questionBlock").append('<h5> Internal error. Try again</h5>');
                    }
                },
                error: function () {
                    $("#questionBlock").append('<h5> Internal error. Try again</h5>');
                }
            });

        }
        function getNextQuestion(){
            var token = $('input[name="__RequestVerificationToken"]').val();
            var myData = { questionId: $("#testQuestionFieldSet").data("id") };
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });

            $.ajax({
                url: "/TestEngine/GetNextQuestion",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data !== "error" && data !== "bound") {
                        appendQuestion(data);
                        getIfAlreadyAswered(data);
                        $("#nextQuestionButton").prop('disabled', false);
                    }
                    else {
                        if (data === "bound")
                            $("#nextQuestionButton").prop('disabled', true);
                        else
                            alert("nani???");
                    }
                },
                error: function () {
                    $("#questionForm").empty();
                }
            });
        }
        function getPrevQuestion() {
            var token = $('input[name="__RequestVerificationToken"]').val();
            var myData = { questionId: $("#testQuestionFieldSet").data("id") };
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });

            $.ajax({
                url: "/TestEngine/GetPrevQuestion",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data !== "error" && data !== "bound") {
                        appendQuestion(data);
                        getIfAlreadyAswered(data);
                        $("#prevQuestionButton").prop('disabled', false);
                    }
                    else
                    {
                        if (data === "bound")
                            $("#prevQuestionButton").prop('disabled', true);
                        else
                            alert("nani???");
                    }
                },
                error: function () {
                    $("#questionForm").empty();
                }
            });
        }
        function getQuestion(questionId) {
            var token = $('input[name="__RequestVerificationToken"]').val();
            var myData = { questionId: questionId };
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });

            $.ajax({
                url: "/TestEngine/GetQuestion",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data !== "error") {
                        appendQuestion(data);
                        getIfAlreadyAswered(data);
                    }
                    else
                        alert("nani???");
                },
                error: function () {
                    $("#questionForm").empty();
                }
            });
        }
        function getIfAlreadyAswered(questionAnswers) {
            var token = $('input[name="__RequestVerificationToken"]').val();
            var myData = { questionId: $("#testQuestionFieldSet").data("id") };
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });

            $.ajax({
                url: "/TestEngine/GetIfAlreadyAnswered",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data !== "error") {
                        CheckAnswer(questionAnswers, data);
                    }
                },
                error: function () {
                    $("#questionForm").empty();
                }
            });
        }
        function getQuestionsId() {
            var token = $('input[name="__RequestVerificationToken"]').val();
            var dataWithAntiforgeryToken =  { '__RequestVerificationToken': token };

            $.ajax({
                url: "/TestEngine/GetQuestionsIds",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    if (data !== "error") {
                        displayQuestionNav(data);
                    }
                    //else
                        //alert("nani???");
                },
                error: function () {
                    $("#questionForm").empty();
                }
            });
        }
        function displayQuestionNav(questionIds) {
            for (let i = 0; i < questionIds.length; i++) {
                let button = $('<button/>', {
                    type: 'button',
                    class: 'btn btn-info center-block',
                    value: questionIds[i],
                    text: (i + 1),
                    click: function () {
                        getQuestion($(this).attr('value'));
                    }
                });
                let div = $('<div/>', { class: 'col-xs-1' }).append(button);
                div.appendTo($("div#questions"));
            }
        }  
        function ConfigureForTheFirstQuestion(question)
        {
            $("#questionForm").show(); 
            $("#startTestElem").remove();
            appendQuestion(question);
            var buttonsRow = $('<div/>', { class: 'row' });
            $('<button/>', { text: 'Prev question', id: 'prevQuestionButton', class: 'btn btn-primary col-xs-2', click: getPrevQuestion }).appendTo(buttonsRow);
            $('<button/>', { text: 'Check answer', id: 'answerButton', class: 'btn btn-success col-xs-offset-3 col-xs-2', click: CheckAnswer }).appendTo(buttonsRow);
            $('<button/>', { text: 'Next question', id: 'nextQuestionButton', class: 'btn btn-primary col-xs-offset-3 col-xs-2', click: getNextQuestion }).appendTo(buttonsRow);
            buttonsRow.insertAfter("#testQuestionFieldSet");
        }
        function appendQuestion(question) {
            $("#testQuestionFieldSet").empty();
            $('<legend/>', { id: 'questionText' }).appendTo("#testQuestionFieldSet");
           // $("#testQuestionFieldSet").append()
            //$("#questionText").empty();
            $("#questionText").append("<h1>" + question.questionText + "</h1>");
            $("#testQuestionFieldSet").data("testCode", question.test.testCode);
            $("#testQuestionFieldSet").data("id", question.id);
            question.testAnswers.forEach(function (element) {
                var input = $('<input/>', { type: 'checkbox', name: 'answer', value: element.id });
                var label = $('<label/>', { text: element.answerText });
                var div = $('<div/>');
                input.appendTo(div);
                label.appendTo(div);
                div.appendTo("#testQuestionFieldSet");
            });
        }
        function showCorrectAnswer(questionAnswers, userAnswers) {
            userAnswers.forEach(function (element) {
                $("input[type=checkbox][value='" + element + "']").closest("div").css("color", "red");
                $("input[type=checkbox][value='" + element + "']").prop('checked', true);
                });

                questionAnswers.forEach(function (element) {
                    $("input[type=checkbox][value='" + element + "']").closest("div").css("color", "green");
            });
            if (isAllCorrect(questionAnswers, userAnswers)) {
                var div = $('<div/>', { id: 'answerMessage', class: 'text-center text-primary col-xs-offset-3 col-xs-2' });
                var h2 = $('<h3/>', { class: 'text-success isCorrectText', text: 'Correct' });
            }
            else {
                var div = $('<div/>', { id: 'answerMessage', class: 'text-center text-primary col-xs-offset-3 col-xs-2' });
                var h2 = $('<h3/>', { class: 'text-danger isCorrectText', text: 'Incorrect' });
            }
            $("#answerButton").remove();
            $("#answerMessage").remove();
            div.append(h2);
            div.insertAfter($("#prevQuestionButton"));
            //$("#nextQuestionButton").removeClass("col-sm-offset-3");
           //$("#nextQuestionButton").addClass("col-sm-offset-8");
            $('input[name="answer"]').each(function () {
                $(this).prop('disabled', true);
            });
        }
        function isAllCorrect(questionAnswers, userAnswered) {
            if (questionAnswers.length !== userAnswered.length)
                return false;
            for (var i = questionAnswers.length; i--;) {
                if (questionAnswers[i] != userAnswered[i])
                    return false;
            }

            return true;
        }
        $("#startButton").on("click", startTest);
    </script>
}

